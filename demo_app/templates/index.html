<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parkinson's Voice Classification</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay (managed by state) -->
    <div id="loading-overlay-container"></div>

    <div class="container mx-auto px-4 py-8 max-w-2xl">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          Parkinson's Voice Classification
        </h1>
        <p class="text-gray-600">MSc Thesis Research Demonstration</p>
      </header>

      <!-- Disclaimer Banner -->
      <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg
              class="h-5 w-5 text-amber-400"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <div class="ml-3 text-sm text-amber-700">
            <strong>Research Demonstration Only.</strong>
            This application is part of an MSc thesis and is not intended for
            medical diagnosis or clinical use.
          </div>
        </div>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="mb-4 p-4 rounded {% if category == 'error' %}bg-red-100 border border-red-400 text-red-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <!-- Model Status -->
      {% if model_error %}
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <h3 class="font-semibold text-red-800 mb-2">Model Not Available</h3>
        <p class="text-red-600 text-sm">{{ model_error }}</p>
        <p class="text-red-600 text-sm mt-2">
          Run
          <code class="bg-red-100 px-1 rounded">make train-demo-model</code> to
          train the inference model.
        </p>
      </div>
      {% else %}

      <!-- Main App Container (mounted by JS) -->
      <div id="app"></div>

      <!-- Model Info -->
      {% if model_info %}
      <div class="bg-gray-50 rounded-lg p-4 mt-6">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">
          Current Model Configuration
        </h3>
        <dl class="grid grid-cols-2 gap-2 text-sm">
          <dt class="text-gray-500">Model:</dt>
          <dd class="text-gray-800">{{ model_info.model_name }}</dd>
          <dt class="text-gray-500">Task:</dt>
          <dd class="text-gray-800">{{ model_info.task }}</dd>
          <dt class="text-gray-500">Features:</dt>
          <dd class="text-gray-800">
            {{ model_info.feature_set }} ({{ model_info.feature_count }})
          </dd>
          <dt class="text-gray-500">Training Samples:</dt>
          <dd class="text-gray-800">{{ model_info.training_samples }}</dd>
        </dl>
      </div>
      {% endif %} {% endif %}

      <!-- Footer -->
      <footer class="mt-8 text-center text-sm text-gray-500">
        <p>
          <a href="{{ url_for('about') }}" class="text-blue-600 hover:underline"
            >About this project</a
          >
        </p>
      </footer>
    </div>

    <script type="module">
      import {
        createSignal,
        createEffect,
        createMemo,
      } from '{{ url_for("static", filename="js/state.js") }}';

      // ============================================================
      // Reactive State (Signals)
      // ============================================================
      const [isRecording, setIsRecording] = createSignal(false);
      const [recordedBlob, setRecordedBlob] = createSignal(null);
      const [isSubmitting, setIsSubmitting] = createSignal(false);
      const [recordingTime, setRecordingTime] = createSignal(0);
      const [activeTab, setActiveTab] = createSignal("upload");

      // ============================================================
      // Computed/Derived Values (createMemo)
      // ============================================================
      const hasBlob = createMemo(() => recordedBlob() !== null);
      const statusMessage = createMemo(() => {
        if (isRecording()) return "üî¥ Recording...";
        if (hasBlob()) return "‚úì Recording Complete";
        return "";
      });

      // Implementation details (not reactive state)
      let mediaRecorder = null;
      let audioChunks = [];
      let timerInterval = null;
      let currentStream = null;

      // ============================================================
      // DOM References
      // ============================================================
      const app = document.getElementById("app");
      const loadingContainer = document.getElementById(
        "loading-overlay-container"
      );

      // ============================================================
      // Loading Overlay
      // ============================================================
      loadingContainer.innerHTML = `
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg p-6 text-center shadow-xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-lg font-semibold text-gray-800">Analyzing voice recording...</p>
            <p class="text-sm text-gray-600">Extracting acoustic features and running classification</p>
          </div>
        </div>
      `;

      const loadingOverlay = document.getElementById("loading-overlay");

      createEffect(() => {
        loadingOverlay.classList.toggle("hidden", !isSubmitting());
      });

      // ============================================================
      // Build Main App HTML
      // ============================================================
      app.innerHTML = `
        <!-- Tabs -->
        <div class="mb-6">
          <!-- Tab List -->
          <div class="bg-white shadow-md rounded-t-lg flex">
            <button id="tab-upload" class="flex-1 px-4 py-3 text-sm font-medium rounded-tl-lg transition-colors">
              Upload File
            </button>
            <button id="tab-record" class="flex-1 px-4 py-3 text-sm font-medium rounded-tr-lg transition-colors">
              Record Audio
            </button>
          </div>

          <!-- Upload Tab Content -->
          <div id="content-upload" class="bg-white shadow-md rounded-b-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
              Upload Voice Recording
            </h2>
            <p class="text-gray-600 mb-4">
              Upload an audio file of a <strong>ReadText</strong> speech task for
              analysis. All common formats supported (WAV, MP3, WebM, etc.).
            </p>
            <form id="analysis-form" action="{{ url_for('analyze') }}" method="POST" enctype="multipart/form-data">
              <div class="mb-4">
                <label for="audio_file" class="block text-sm font-medium text-gray-700 mb-2">
                  Audio File (any format)
                </label>
                <input
                  type="file"
                  id="audio_file"
                  name="audio_file"
                  accept="audio/*"
                  required
                  class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <button id="upload-submit-btn" type="submit" class="w-full py-2 px-4 rounded font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                Analyze Recording
              </button>
            </form>
          </div>

          <!-- Record Tab Content -->
          <div id="content-record" class="hidden bg-white shadow-md rounded-b-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
              Record Voice Sample
            </h2>
            
            <!-- Text to Read -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <h3 class="font-semibold text-blue-900 mb-2">ReadText Task Prompt</h3>
              <p class="text-gray-700 leading-relaxed">
                "The quick brown fox jumps over the lazy dog. Peter Piper picked a
                peck of pickled peppers. How much wood would a woodchuck chuck if a
                woodchuck could chuck wood?"
              </p>
              <p class="text-sm text-gray-600 mt-2 italic">
                Read this text clearly and naturally at a comfortable pace.
              </p>
            </div>

            <!-- Recording Controls -->
            <div class="space-y-4">
              <!-- Status Display -->
              <div id="recording-status" class="hidden text-center py-2 px-4 rounded">
                <span id="status-text" class="font-semibold"></span>
                <span id="recording-timer" class="ml-2 text-sm"></span>
              </div>

              <!-- Control Buttons -->
              <div class="flex gap-3">
                <button id="start-btn" class="flex-1 py-2 px-4 rounded font-medium text-white bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                  üé§ Start Recording
                </button>
                <button id="stop-btn" class="flex-1 py-2 px-4 rounded font-medium text-white bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                  ‚èπ Stop Recording
                </button>
              </div>

              <!-- Audio Playback -->
              <div id="playback-section" class="hidden space-y-3">
                <audio id="recorded-audio" controls class="w-full"></audio>
                <div class="flex gap-3">
                  <button id="reset-btn" class="flex-1 py-2 px-4 rounded font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors">
                    üîÑ Record Again
                  </button>
                  <button id="analyze-btn" class="flex-1 py-2 px-4 rounded font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    ‚úì Analyze Recording
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // ============================================================
      // DOM Element References
      // ============================================================
      const tabUpload = document.getElementById("tab-upload");
      const tabRecord = document.getElementById("tab-record");
      const contentUpload = document.getElementById("content-upload");
      const contentRecord = document.getElementById("content-record");
      const uploadSubmitBtn = document.getElementById("upload-submit-btn");
      const analysisForm = document.getElementById("analysis-form");
      const audioFileInput = document.getElementById("audio_file");

      const startBtn = document.getElementById("start-btn");
      const stopBtn = document.getElementById("stop-btn");
      const resetBtn = document.getElementById("reset-btn");
      const analyzeBtn = document.getElementById("analyze-btn");
      const recordingStatus = document.getElementById("recording-status");
      const statusText = document.getElementById("status-text");
      const recordingTimer = document.getElementById("recording-timer");
      const playbackSection = document.getElementById("playback-section");
      const recordedAudio = document.getElementById("recorded-audio");

      // ============================================================
      // Tab Switching
      // ============================================================
      tabUpload.addEventListener("click", () => setActiveTab("upload"));
      tabRecord.addEventListener("click", () => setActiveTab("record"));

      createEffect(() => {
        const tab = activeTab();

        // Update tab button styles
        tabUpload.className = `flex-1 px-4 py-3 text-sm font-medium rounded-tl-lg transition-colors ${
          tab === "upload"
            ? "bg-blue-600 text-white"
            : "bg-gray-100 text-gray-600 hover:bg-gray-200"
        }`;
        tabRecord.className = `flex-1 px-4 py-3 text-sm font-medium rounded-tr-lg transition-colors ${
          tab === "record"
            ? "bg-blue-600 text-white"
            : "bg-gray-100 text-gray-600 hover:bg-gray-200"
        }`;

        // Show/hide content
        contentUpload.classList.toggle("hidden", tab !== "upload");
        contentRecord.classList.toggle("hidden", tab !== "record");
      });

      // ============================================================
      // Upload Form
      // ============================================================
      analysisForm.addEventListener("submit", (e) => {
        if (!audioFileInput.files.length) {
          e.preventDefault();
          alert("Please select an audio file");
          return;
        }
        setIsSubmitting(true);
      });

      createEffect(() => {
        const submitting = isSubmitting();
        uploadSubmitBtn.disabled = submitting;
        uploadSubmitBtn.textContent = submitting
          ? "Processing..."
          : "Analyze Recording";
      });

      // ============================================================
      // Recording State Effects
      // ============================================================
      createEffect(() => {
        const recording = isRecording();
        const hasRecording = hasBlob();

        // Start button: disabled when recording OR has recording
        startBtn.disabled = recording || hasRecording;

        // Stop button: enabled only when recording
        stopBtn.disabled = !recording;
        stopBtn.className = `flex-1 py-2 px-4 rounded font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors ${
          recording ? "bg-red-600 hover:bg-red-700" : "bg-gray-400"
        }`;

        // Status visibility and styling
        recordingStatus.classList.toggle("hidden", !recording && !hasRecording);
        recordingStatus.className = `text-center py-2 px-4 rounded ${
          recording
            ? "bg-red-100 text-red-800"
            : hasRecording
            ? "bg-green-100 text-green-800"
            : "hidden"
        }`;

        // Use computed status message
        statusText.textContent = statusMessage();

        // Playback section visibility
        playbackSection.classList.toggle("hidden", !hasRecording);

        const blob = recordedBlob();
        if (blob) {
          const currentSrc = recordedAudio.src;
          if (!currentSrc || !currentSrc.startsWith("blob:")) {
            recordedAudio.src = URL.createObjectURL(blob);
          }
        } else {
          if (recordedAudio.src) {
            URL.revokeObjectURL(recordedAudio.src);
            recordedAudio.src = "";
          }
        }
      });

      // Timer updates
      createEffect(() => {
        recordingTimer.textContent = `${recordingTime()}s`;
      });

      // Analyze button loading state
      createEffect(() => {
        const submitting = isSubmitting();
        analyzeBtn.disabled = submitting;
        analyzeBtn.textContent = submitting
          ? "Processing..."
          : "‚úì Analyze Recording";
      });

      // ============================================================
      // Recording Functions
      // ============================================================
      function checkRecordingSupport() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert(
            "Audio recording is not supported in your browser. Please use Chrome or Firefox."
          );
          return false;
        }
        return true;
      }

      async function startRecording() {
        if (!checkRecordingSupport()) return;

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: { channelCount: 1, sampleRate: 22050 },
          });

          audioChunks = [];
          currentStream = stream;
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

          mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: "audio/webm" });

            // Cleanup stream
            if (currentStream) {
              currentStream.getTracks().forEach((t) => t.stop());
              currentStream = null;
            }
            clearInterval(timerInterval);

            // Update state
            setIsRecording(false);
            setRecordedBlob(blob);
          };

          mediaRecorder.start();
          setRecordingTime(0);

          // Start timer
          timerInterval = setInterval(() => {
            setRecordingTime((t) => t + 1);
          }, 1000);

          setIsRecording(true);
        } catch (err) {
          console.error("Error accessing microphone:", err);
          alert("Could not access microphone. Please grant permission.");
        }
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      }

      function resetRecording() {
        audioChunks = [];
        setRecordedBlob(null);
        setRecordingTime(0);
      }

      function submitRecording() {
        const blob = recordedBlob();
        if (!blob) {
          alert("No recording available");
          return;
        }

        setIsSubmitting(true);

        // Submit via form POST
        const form = document.createElement("form");
        form.method = "POST";
        form.action = '{{ url_for("analyze") }}';
        form.enctype = "multipart/form-data";

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.name = "recorded_audio";

        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(
          new File([blob], "recording.webm", { type: "audio/webm" })
        );
        fileInput.files = dataTransfer.files;

        form.appendChild(fileInput);
        document.body.appendChild(form);
        form.submit();
      }

      // ============================================================
      // Event Listeners
      // ============================================================
      startBtn.addEventListener("click", startRecording);
      stopBtn.addEventListener("click", stopRecording);
      resetBtn.addEventListener("click", resetRecording);
      analyzeBtn.addEventListener("click", submitRecording);
    </script>
  </body>
</html>
